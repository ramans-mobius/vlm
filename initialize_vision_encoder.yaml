name: 2 Initialize Vision Encoder
description: Initializes a vision encoder suitable for any image type using nesy-factory's vision encoders.
inputs:
  - name: encoder_type
    type: String
    default: "clip"
    description: 'Type of vision encoder (clip, pretrained, resnet, vit)'
  - name: model_name
    type: String
    default: "openai/clip-vit-base-patch32"
    description: 'Hugging Face model name'
  - name: projection_dim
    type: Integer
    default: "512"
    description: 'Output projection dimension'
  - name: unfreeze_layers
    type: Integer
    default: "0"
    description: 'Number of layers to unfreeze for training'
  - name: image_types
    type: String
    default: "general"
    description: 'Expected image types: general, objects, scenes, faces, medical, etc.'
outputs:
  - name: encoder_config
    type: Data
  - name: encoder_report
    type: Data
  - name: schema_json
    type: Data
implementation:
  container:
    image: gurpreetgandhi/nesy-factory:v29
    command:
      - sh
      - -c
      - |
        python3 -c "
        import sys, os, json

        # Get arguments from command line
        encoder_type = sys.argv[1]
        model_name = sys.argv[2]
        projection_dim = int(sys.argv[3])
        unfreeze_layers = int(sys.argv[4])
        image_types = sys.argv[5]
        encoder_config_path = sys.argv[6]
        encoder_report_path = sys.argv[7]
        schema_output_path = sys.argv[8]

        # Model recommendations based on image types
        model_recommendations = {
            'general': ['openai/clip-vit-base-patch32', 'google/vit-base-patch16-224'],
            'objects': ['facebook/detr-resnet-50', 'microsoft/beit-base-patch16-224'],
            'scenes': ['openai/clip-vit-large-patch14', 'microsoft/swin-base-patch4-window7-224'],
            'faces': 'google/vit-base-patch16-224',
            'medical': 'microsoft/resnet-50',
            'satellite': 'microsoft/beit-base-patch16-224'
        }

        recommended_model = model_recommendations.get(image_types, model_name)

        encoder_config = {
            'encoder_type': encoder_type,
            'model_name': model_name,
            'recommended_model': recommended_model,
            'projection_dim': projection_dim,
            'unfreeze_layers': unfreeze_layers,
            'image_types': image_types,
            'device': 'cuda' if os.system('nvidia-smi > /dev/null 2>&1') == 0 else 'cpu',
            'purpose': 'generic_image_captioning'
        }

        report = {
            'status': 'success',
            'encoder_type': encoder_type,
            'model_name': model_name,
            'projection_dim': projection_dim,
            'unfreeze_layers': unfreeze_layers,
            'image_types_supported': image_types,
            'recommended_for': recommended_model,
            'features': 'generic_image_feature_extraction',
            'output_dim': projection_dim,
            'application': 'universal_image_captioning'
        }

        os.makedirs(os.path.dirname(encoder_config_path) or '.', exist_ok=True)
        with open(encoder_config_path, 'w') as f:
            json.dump(encoder_config, f, indent=2)

        with open(encoder_report_path, 'w') as f:
            json.dump(report, f, indent=2)

        schema = {
            'vision_encoder': encoder_config,
            'capabilities': ['generic_feature_extraction', 'multimodal_alignment', 'cross_domain_understanding'],
            'supported_domains': ['objects', 'scenes', 'people', 'animals', 'abstract', 'technical'],
            'flexibility': 'high'
        }
        with open(schema_output_path, 'w') as f:
            json.dump(schema, f, indent=2)

        print(f'[SUCCESS] Generic vision encoder config saved: {encoder_config_path}')
        " "$1" "$2" "$3" "$4" "$5" "$6" "$7" "$8"
    args:
      - {inputValue: encoder_type}
      - {inputValue: model_name}
      - {inputValue: projection_dim}
      - {inputValue: unfreeze_layers}
      - {inputValue: image_types}
      - {outputPath: encoder_config}
      - {outputPath: encoder_report}
      - {outputPath: schema_json}
